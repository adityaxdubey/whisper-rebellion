<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rebellion Chat</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; }
    .chat-container { display:flex; height:100vh; }
    .sidebar { width:280px; border-right:1px solid #ddd; padding:10px; overflow:auto; }
    .chat-main { flex:1; display:flex; flex-direction:column; }
    .user { padding:8px; border-radius:6px; margin-bottom:6px; cursor:pointer; }
    .user.active, .user:hover { background:#f0f0f0; }
    .header { padding:10px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center; }
    .messages { flex:1; padding:10px; overflow:auto; background:#fafafa; }
    .msg { margin:6px 0; max-width:70%; padding:8px 10px; border-radius:12px; }
    .me { background:#d7f7d7; margin-left:auto; }
    .them { background:#fff; }
    .composer { display:flex; gap:8px; padding:10px; border-top:1px solid #ddd; }
    .composer input { flex:1; padding:8px; }
    .search { display:flex; gap:6px; }
    .results { border-top:1px dashed #ccc; padding:8px; max-height:200px; overflow:auto; background:white; }
    .result { padding:6px 0; border-bottom:1px dotted #eee; }
    small { color:#666; }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="sidebar">
      <h3>People</h3>
      <div id="users"></div>
    </div>
    <div class="chat-main">
      <div class="header">
        <div>
          <div id="title">Select a user</div>
          <small id="me"></small>
        </div>
        <div class="search">
          <input id="q" placeholder="Search messages..." />
          <button id="searchBtn">Search</button>
        </div>
      </div>
      <div class="messages" id="messages"></div>
      <div class="results" id="results" style="display:none;"></div>
      <div class="composer">
        <input id="text" placeholder="Type a message..." />
        <button id="send">Send</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    let socket;
    let token;
    let currentUser;
    let selectedUser = null;

    function ensureAuth() {
      token = localStorage.getItem('token');
      currentUser = JSON.parse(localStorage.getItem('user') || 'null');
      if (!token || !currentUser) {
        alert('Please log in first'); window.location = '/'; return false;
      }
      document.getElementById('me').innerText = `You: ${currentUser.name} (id ${currentUser.id})`;
      return true;
    }

    async function api(path) {
      const res = await fetch(`${API_URL}${path}`, { headers: { Authorization: `Bearer ${token}` }});
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function connectSocket() {
      socket = io(API_URL, {
        transports: ["websocket"],
        auth: { token }
      });
      socket.on('connected', () => console.log('Socket connected'));
      socket.on('new_message', (msg) => {
        if (!selectedUser) return;
        const isRelevant = (msg.sender_id === selectedUser.id && msg.receiver_id === currentUser.id);
        if (isRelevant) appendMessage(msg, false);
      });
      socket.on('message_sent', (msg) => {
        if (!selectedUser) return;
        if (msg.receiver_id === selectedUser.id) appendMessage(msg, true);
      });
    }

    async function loadUsers() {
      const users = await api('/users');
      displayUsers(users);
    }

    function displayUsers(users) {
      const el = document.getElementById('users');
      el.innerHTML = '';
      users.forEach(u => {
        const div = document.createElement('div');
        div.className = 'user';
        div.textContent = `${u.name} (${u.email})`;
        div.onclick = (e) => selectUser(u, e);
        div.dataset.uid = u.id;
        el.appendChild(div);
      });
    }

    async function selectUser(user, event) {
      selectedUser = user;
      document.getElementById('title').innerText = `Chat with ${user.name}`;
      document.querySelectorAll('.user').forEach(n => n.classList.remove('active'));
      event?.currentTarget?.classList?.add('active');
      document.getElementById('results').style.display = 'none';
      await loadMessages();
    }

    async function loadMessages() {
      if (!selectedUser) return;
      const data = await api(`/messages?userId=${selectedUser.id}&limit=50`);
      const box = document.getElementById('messages');
      box.innerHTML = '';
      data.reverse().forEach(m => appendMessage(m, m.sender_id === currentUser.id));
      box.scrollTop = box.scrollHeight;
    }

    function appendMessage(m, mine) {
      const box = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = `msg ${mine ? 'me' : 'them'}`;
      const when = new Date(m.created_at).toLocaleTimeString();
      div.innerHTML = `<strong>${m.sender_name || (mine ? 'You' : '')}</strong><br>${m.message}<br><small>${when}</small>`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    async function sendMsg() {
      if (!selectedUser) return alert('Select a user first');
      const text = document.getElementById('text').value.trim();
      if (!text) return;
      socket.emit('send_message', { receiver_id: selectedUser.id, message: text });
      document.getElementById('text').value = '';
    }

    async function doSearch() {
      const q = document.getElementById('q').value.trim();
      if (!q) return;
      if (!selectedUser) return alert('Select a user first');
      const res = await api(`/semantic-search?userId=${selectedUser.id}&q=${encodeURIComponent(q)}&limit=10`);
      const pane = document.getElementById('results');
      if (!res.results || !res.results.length) {
        pane.style.display = 'block';
        pane.innerHTML = '<em>No matches</em>';
        return;
      }
      pane.style.display = 'block';
      pane.innerHTML = res.results.map(r => {
        const when = new Date(r.created_at).toLocaleString();
        const score = (r.similarity_score ?? 0).toFixed(3);
        return `<div class="result"><div>${r.message}</div><small>${when} â€¢ score ${score}</small></div>`;
      }).join('');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      if (!ensureAuth()) return;
      connectSocket();
      await loadUsers();
      document.getElementById('send').onclick = sendMsg;
      document.getElementById('text').addEventListener('keydown', e => { if (e.key === 'Enter') sendMsg(); });
      document.getElementById('searchBtn').onclick = doSearch;
      document.getElementById('q').addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });
    });
  </script>
</body>
</html>
